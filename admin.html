<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Panel - Nowraj</title>
  
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  
  <style>
    /* Import your main website styles */
    @import url('styles.css');
    
    /* Admin specific styles */
    .admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 100px 20px 40px;
    }
    
    .admin-header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    .admin-title {
      font-size: 2.5rem;
      background: linear-gradient(135deg, var(--accent), #3385FF);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }
    
    .admin-subtitle {
      color: var(--muted);
      font-size: 1.1rem;
    }
    
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 1px solid var(--card-border);
      padding-bottom: 10px;
    }
    
    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: var(--muted);
      cursor: pointer;
      transition: all var(--transition);
      font-weight: 600;
    }
    
    .tab.active {
      background: var(--accent);
      color: white;
    }
    
    .tab-content {
      display: none;
      animation: fadeIn 0.5s ease-out;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .form-container {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .form-title {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-grid {
      display: grid;
      gap: 20px;
      grid-template-columns: 1fr 1fr;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      color: var(--text);
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 12px 16px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 10px;
      color: var(--text);
      font-size: 1rem;
      transition: all var(--transition);
      backdrop-filter: var(--glass-blur);
      font-family: inherit;
    }
    
    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
    }
    
    .form-btn {
      padding: 12px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 102, 255, 0.3);
    }
    
    .form-btn.secondary {
      background: transparent;
      border: 1px solid var(--card-border);
      color: var(--text);
    }
    
    .message {
      margin-top: 20px;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 500;
      animation: fadeInUp 0.3s ease-out;
    }
    
    .error {
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
      border: 1px solid rgba(244, 67, 54, 0.2);
    }
    
    .success {
      background: rgba(76, 175, 80, 0.1);
      color: #4CAF50;
      border: 1px solid rgba(76, 175, 80, 0.2);
    }
    
    .content-list {
      display: grid;
      gap: 20px;
      margin-top: 30px;
    }
    
    .content-item {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 20px;
      transition: all var(--transition);
    }
    
    .content-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }
    
    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .content-title {
      font-size: 1.2rem;
      color: var(--text);
      margin: 0;
      flex: 1;
    }
    
    .content-meta {
      display: flex;
      gap: 15px;
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    
    .content-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn-small {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all var(--transition);
    }
    
    .btn-edit {
      background: rgba(33, 150, 243, 0.1);
      color: #2196F3;
    }
    
    .btn-delete {
      background: rgba(244, 67, 54, 0.1);
      color: #f44336;
    }
    
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .tabs {
        flex-wrap: wrap;
      }
      
      .content-header {
        flex-direction: column;
        gap: 10px;
      }
      
      .content-actions {
        width: 100%;
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
  <!-- Header matching main website -->
  <header class="site-header" role="banner">
    <div class="header-inner">
      <a class="brand" href="index.html">
        <img src="assets/nowraj-logo.png" alt="Nowraj" class="brand-img" />
      </a>
      <nav class="nav" aria-label="Main navigation">
        <ul class="nav-list">
          <li><a href="index.html" class="nav-link">Back to Site</a></li>
          <li><a href="#videos" class="nav-link active">Videos</a></li>
          <li><a href="#blogs" class="nav-link">Blogs</a></li>
        </ul>
      </nav>
      <div class="actions">
        <button id="logoutBtn" class="icon-btn" aria-label="Logout">
          <i data-lucide="log-out"></i>
        </button>
      </div>
    </div>
  </header>

  <div class="admin-container">
    <div class="admin-header">
      <h1 class="admin-title">Admin Panel</h1>
      <p class="admin-subtitle">Manage your content and upload new material</p>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="videos">üéµ Piano Videos</button>
      <button class="tab" data-tab="blogs">üìù Blog Posts</button>
    </div>

    <!-- Videos Tab -->
    <div id="videos-tab" class="tab-content active">
      <div class="form-container">
        <h2 class="form-title">
          <i data-lucide="plus"></i>
          Add New Piano Video
        </h2>
        <form id="videoForm" class="form-grid">
          <div class="form-group full-width">
            <label class="form-label">YouTube Video URL</label>
            <input type="url" id="videoUrl" class="form-input" placeholder="https://www.youtube.com/watch?v=..." required>
          </div>
          <div class="form-group">
            <label class="form-label">Piece Name</label>
            <input type="text" id="pieceName" class="form-input" placeholder="Moonlight Sonata" required>
          </div>
          <div class="form-group">
            <label class="form-label">Composer/Creator</label>
            <input type="text" id="composer" class="form-input" placeholder="Ludwig van Beethoven" required>
          </div>
          <div class="form-group">
            <label class="form-label">Played By</label>
            <input type="text" id="playedBy" class="form-input" placeholder="Nowraj Pandey" required>
          </div>
          <div class="form-group">
            <label class="form-label">Difficulty Level</label>
            <select id="difficulty" class="form-select">
              <option value="beginner">Beginner</option>
              <option value="intermediate">Intermediate</option>
              <option value="advanced">Advanced</option>
              <option value="professional">Professional</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Duration (minutes)</label>
            <input type="number" id="duration" class="form-input" placeholder="5" min="1">
          </div>
          <div class="form-group full-width">
            <label class="form-label">Description</label>
            <textarea id="videoDescription" class="form-textarea" placeholder="Describe this piece and your performance..."></textarea>
          </div>
          <div class="form-group full-width">
            <button type="submit" class="form-btn">
              <i data-lucide="upload"></i>
              Upload Video
            </button>
          </div>
        </form>
        <div id="videoMessage" class="message"></div>
      </div>

      <div class="form-container">
        <h2 class="form-title">
          <i data-lucide="list-video"></i>
          Existing Videos
        </h2>
        <div id="videosList" class="content-list">
          <!-- Videos will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Blogs Tab -->
    <div id="blogs-tab" class="tab-content">
      <div class="form-container">
        <h2 class="form-title">
          <i data-lucide="edit-3"></i>
          Write New Blog Post
        </h2>
        <form id="blogForm" class="form-grid">
          <div class="form-group">
            <label class="form-label">Blog Title</label>
            <input type="text" id="blogTitle" class="form-input" placeholder="My Web Development Journey" required>
          </div>
          <div class="form-group">
            <label class="form-label">Category</label>
            <select id="blogCategory" class="form-select">
              <option value="technology">Technology</option>
              <option value="music">Music</option>
              <option value="education">Education</option>
              <option value="personal">Personal</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label class="form-label">Featured Image URL</label>
            <input type="url" id="blogImage" class="form-input" placeholder="https://example.com/image.jpg">
          </div>
          <div class="form-group full-width">
            <label class="form-label">Blog Content</label>
            <textarea id="blogContent" class="form-textarea" placeholder="Write your blog post here..." rows="10" required></textarea>
          </div>
          <div class="form-group full-width">
            <label class="form-label">Excerpt (Short Description)</label>
            <textarea id="blogExcerpt" class="form-textarea" placeholder="Brief description of your blog post..." rows="3" required></textarea>
          </div>
          <div class="form-group full-width">
            <button type="submit" class="form-btn">
              <i data-lucide="save"></i>
              Publish Blog Post
            </button>
          </div>
        </form>
        <div id="blogMessage" class="message"></div>
      </div>

      <div class="form-container">
        <h2 class="form-title">
          <i data-lucide="file-text"></i>
          Existing Blog Posts
        </h2>
        <div id="blogsList" class="content-list">
          <!-- Blogs will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCP-FF-B3hKADVJ5l5us5LAAQl2Sm-_ebU",
      authDomain: "mywebsite-b05e8.firebaseapp.com",
      projectId: "mywebsite-b05e8",
      storageBucket: "mywebsite-b05e8.firebasestorage.app",
      messagingSenderId: "1095561283748",
      appId: "1:1095561283748:web:9b1a7735fa787dded2be31"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Check authentication
    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = 'login.html';
      } else {
        console.log('User authenticated:', user.email);
        loadVideos();
        loadBlogs();
      }
    });

    // Initialize icons
    document.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) {
        lucide.createIcons();
      }
    });

    // Tab functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remove active class from all tabs and contents
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding content
        tab.classList.add('active');
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(`${tabId}-tab`).classList.add('active');
      });
    });

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', () => {
      signOut(auth).then(() => {
        window.location.href = 'login.html';
      });
    });

    // Extract YouTube ID from URL
    function getYouTubeId(url) {
      const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
      const match = url.match(regExp);
      return (match && match[7].length === 11) ? match[7] : null;
    }

    // Video form submission
    document.getElementById('videoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const url = document.getElementById('videoUrl').value;
      const pieceName = document.getElementById('pieceName').value;
      const composer = document.getElementById('composer').value;
      const playedBy = document.getElementById('playedBy').value;
      const difficulty = document.getElementById('difficulty').value;
      const duration = document.getElementById('duration').value;
      const description = document.getElementById('videoDescription').value;
      const message = document.getElementById('videoMessage');

      const youtubeId = getYouTubeId(url);
      if (!youtubeId) {
        message.className = 'message error';
        message.textContent = 'Please enter a valid YouTube URL';
        return;
      }

      if (!pieceName || !composer || !playedBy) {
        message.className = 'message error';
        message.textContent = 'Please fill all required fields';
        return;
      }

      try {
        message.className = 'message';
        message.textContent = 'Uploading video...';

        // Check if user is authenticated
        const user = auth.currentUser;
        if (!user) {
          throw new Error('User not authenticated. Please log in again.');
        }

        await addDoc(collection(db, "pianoVideos"), {
          youtubeId,
          pieceName,
          composer,
          playedBy,
          difficulty,
          duration: parseInt(duration) || 0,
          description,
          timestamp: serverTimestamp(),
          uploadedBy: user.uid,
          uploadedByEmail: user.email
        });

        message.className = 'message success';
        message.textContent = 'Video uploaded successfully!';
        
        // Clear form
        document.getElementById('videoForm').reset();
        
        // Reload videos
        loadVideos();
      } catch (error) {
        console.error('Upload error:', error);
        message.className = 'message error';
        if (error.code === 'permission-denied') {
          message.textContent = 'Permission denied. Please check your Firebase security rules.';
        } else {
          message.textContent = 'Error: ' + error.message;
        }
      }
    });

    // Blog form submission
    document.getElementById('blogForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const title = document.getElementById('blogTitle').value;
      const category = document.getElementById('blogCategory').value;
      const image = document.getElementById('blogImage').value;
      const content = document.getElementById('blogContent').value;
      const excerpt = document.getElementById('blogExcerpt').value;
      const message = document.getElementById('blogMessage');

      if (!title || !content || !excerpt) {
        message.className = 'message error';
        message.textContent = 'Please fill all required fields';
        return;
      }

      try {
        message.className = 'message';
        message.textContent = 'Publishing blog post...';

        // Check if user is authenticated
        const user = auth.currentUser;
        if (!user) {
          throw new Error('User not authenticated. Please log in again.');
        }

        await addDoc(collection(db, "blogs"), {
          title,
          category,
          image,
          content,
          excerpt,
          timestamp: serverTimestamp(),
          author: user.uid,
          authorEmail: user.email
        });

        message.className = 'message success';
        message.textContent = 'Blog post published successfully!';
        
        // Clear form
        document.getElementById('blogForm').reset();
        
        // Reload blogs
        loadBlogs();
      } catch (error) {
        console.error('Blog upload error:', error);
        message.className = 'message error';
        if (error.code === 'permission-denied') {
          message.textContent = 'Permission denied. Please check your Firebase security rules.';
        } else {
          message.textContent = 'Error: ' + error.message;
        }
      }
    });

    // Load videos from Firestore
    async function loadVideos() {
      const videosList = document.getElementById('videosList');
      videosList.innerHTML = '<p>Loading videos...</p>';

      try {
        const querySnapshot = await getDocs(collection(db, "pianoVideos"));
        videosList.innerHTML = '';

        if (querySnapshot.empty) {
          videosList.innerHTML = '<p>No videos uploaded yet.</p>';
          return;
        }

        querySnapshot.forEach((doc) => {
          const video = doc.data();
          const videoItem = document.createElement('div');
          videoItem.className = 'content-item';
          videoItem.innerHTML = `
            <div class="content-header">
              <h3 class="content-title">${video.pieceName}</h3>
              <div class="content-actions">
                <button class="btn-small btn-delete" onclick="deleteVideo('${doc.id}')">
                  <i data-lucide="trash-2" width="14" height="14"></i> Delete
                </button>
              </div>
            </div>
            <div class="content-meta">
              <span><i data-lucide="user" width="14" height="14"></i> ${video.playedBy}</span>
              <span><i data-lucide="music" width="14" height="14"></i> ${video.composer}</span>
              <span><i data-lucide="star" width="14" height="14"></i> ${video.difficulty}</span>
              ${video.duration ? `<span><i data-lucide="clock" width="14" height="14"></i> ${video.duration} min</span>` : ''}
            </div>
            ${video.description ? `<p>${video.description}</p>` : ''}
            <div style="margin-top: 15px;">
              <iframe 
                width="100%" 
                height="200" 
                src="https://www.youtube.com/embed/${video.youtubeId}" 
                frameborder="0" 
                allowfullscreen
                style="border-radius: 8px;"
              ></iframe>
            </div>
          `;
          videosList.appendChild(videoItem);
        });

        // Refresh icons
        if (window.lucide) {
          lucide.createIcons();
        }
      } catch (error) {
        console.error('Load videos error:', error);
        videosList.innerHTML = '<p class="message error">Error loading videos: ' + error.message + '</p>';
      }
    }

    // Load blogs from Firestore
    async function loadBlogs() {
      const blogsList = document.getElementById('blogsList');
      blogsList.innerHTML = '<p>Loading blogs...</p>';

      try {
        const querySnapshot = await getDocs(collection(db, "blogs"));
        blogsList.innerHTML = '';

        if (querySnapshot.empty) {
          blogsList.innerHTML = '<p>No blog posts yet.</p>';
          return;
        }

        querySnapshot.forEach((doc) => {
          const blog = doc.data();
          const blogItem = document.createElement('div');
          blogItem.className = 'content-item';
          
          // Safely handle timestamp
          let displayDate = 'Recently';
          if (blog.timestamp) {
            try {
              if (typeof blog.timestamp.toDate === 'function') {
                displayDate = blog.timestamp.toDate().toLocaleDateString();
              } else if (blog.timestamp.seconds) {
                displayDate = new Date(blog.timestamp.seconds * 1000).toLocaleDateString();
              } else if (blog.timestamp._seconds) {
                displayDate = new Date(blog.timestamp._seconds * 1000).toLocaleDateString();
              }
            } catch (error) {
              console.error('Error formatting blog date:', error);
            }
          }

          blogItem.innerHTML = `
            <div class="content-header">
              <h3 class="content-title">${blog.title || 'Untitled Post'}</h3>
              <div class="content-actions">
                <button class="btn-small btn-delete" onclick="deleteBlog('${doc.id}')">
                  <i data-lucide="trash-2" width="14" height="14"></i> Delete
                </button>
              </div>
            </div>
            <div class="content-meta">
              <span><i data-lucide="folder" width="14" height="14"></i> ${blog.category || 'General'}</span>
              <span><i data-lucide="calendar" width="14" height="14"></i> ${displayDate}</span>
            </div>
            <p><strong>Excerpt:</strong> ${blog.excerpt || 'No excerpt available'}</p>
            ${blog.image ? `<img src="${blog.image}" alt="${blog.title}" style="width: 100%; border-radius: 8px; margin-top: 10px;">` : ''}
          `;
          blogsList.appendChild(blogItem);
        });

        // Refresh icons
        if (window.lucide) {
          lucide.createIcons();
        }
      } catch (error) {
        console.error('Load blogs error:', error);
        blogsList.innerHTML = '<p class="message error">Error loading blogs: ' + error.message + '</p>';
      }
    }

    // Delete functions
    async function deleteVideo(id) {
      if (confirm('Are you sure you want to delete this video?')) {
        try {
          await deleteDoc(doc(db, "pianoVideos", id));
          loadVideos();
        } catch (error) {
          console.error('Delete video error:', error);
          alert('Error deleting video: ' + error.message);
        }
      }
    }

    async function deleteBlog(id) {
      if (confirm('Are you sure you want to delete this blog post?')) {
        try {
          await deleteDoc(doc(db, "blogs", id));
          loadBlogs();
        } catch (error) {
          console.error('Delete blog error:', error);
          alert('Error deleting blog: ' + error.message);
        }
      }
    }

    // Make functions global for onclick handlers
    window.deleteVideo = deleteVideo;
    window.deleteBlog = deleteBlog;
  </script>
</body>
</html>