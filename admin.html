<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Nowraj Portfolio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin.css">
</head>

<body>
    <div class="admin-container">
        <!-- Auth Section -->
        <section id="auth-section" class="auth-section active">
            <h2>Admin Login</h2>
            <div class="form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" placeholder="admin@example.com">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="••••••••">
            </div>
            <button id="login-btn">Login to Dashboard</button>
        </section>

        <!-- Dashboard Section -->
        <section id="dashboard-section" class="dashboard-section">
            <button id="logout-btn" class="logout-btn">Logout</button>
            <h2>Dashboard</h2>

            <div class="tabs">
                <div class="tab active" data-tab="blogs">Manage Blogs</div>
                <div class="tab" data-tab="piano">Manage Piano Videos</div>
            </div>

            <!-- Blogs Panel -->
            <div id="blogs-panel" class="tab-panel active">
                <div class="form-group">
                    <label for="blog-title">Blog Title</label>
                    <input type="text" id="blog-title" placeholder="Enter title">
                </div>
                <div class="form-group">
                    <label for="blog-image">Image URL</label>
                    <input type="text" id="blog-image" placeholder="https://unsplash.com/...">
                </div>
                <div class="form-group">
                    <label for="blog-content">Content</label>
                    <textarea id="blog-content" rows="6" placeholder="Write your blog content here..."></textarea>
                </div>
                <button id="add-blog-btn">Publish Blog</button>

                <div class="content-list" id="blogs-list">
                    <!-- Dynamic blogs will appear here -->
                </div>
            </div>

            <!-- Piano Panel -->
            <div id="piano-panel" class="tab-panel" style="display: none;">
                <div class="form-group">
                    <label for="piano-title">Video Title</label>
                    <input type="text" id="piano-title" placeholder="Rush E, Interstellar, etc.">
                </div>
                <div class="form-group">
                    <label for="piano-url">YouTube URL</label>
                    <input type="text" id="piano-url" placeholder="https://www.youtube.com/watch?v=...">
                </div>
                <button id="add-piano-btn">Add Video</button>

                <div class="content-list" id="piano-list">
                    <!-- Dynamic piano videos will appear here -->
                </div>
            </div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBUHPDj1TP2rU7dXGtiQ1AdnU24yoB5JuI",
            authDomain: "my-portfolio-4b61e.firebaseapp.com",
            projectId: "my-portfolio-4b61e",
            storageBucket: "my-portfolio-4b61e.firebasestorage.app",
            messagingSenderId: "1095219957957",
            appId: "1:1095219957957:web:3692480026f6a1ee6e60ac",
            measurementId: "G-73CFL03NP7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();

        const authSection = document.getElementById('auth-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // Authentication Logic
        loginBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert("Login failed: " + error.message);
            }
        });

        logoutBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                authSection.classList.remove('active');
                dashboardSection.classList.add('active');
                loadBlogs();
                loadPianoVideos();
            } else {
                authSection.classList.add('active');
                dashboardSection.classList.remove('active');
            }
        });

        // Tab Switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
                tab.classList.add('active');
                const panelId = tab.dataset.tab + '-panel';
                document.getElementById(panelId).style.display = 'block';
            });
        });

        // Helper: Convert YouTube URL to Embed URL
        function getEmbedUrl(url) {
            if (!url) return '';
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? `https://www.youtube.com/embed/${match[2]}` : url;
        }

        // Blogs Logic
        const addBlogBtn = document.getElementById('add-blog-btn');
        addBlogBtn.addEventListener('click', async () => {
            const title = document.getElementById('blog-title').value;
            const image = document.getElementById('blog-image').value;
            const content = document.getElementById('blog-content').value;

            if (!title || !content) return alert("Title and Content are required");

            try {
                await addDoc(collection(db, "blogs"), {
                    title,
                    imageUrl: image || 'https://images.unsplash.com/photo-1498050108023-c5249f4df085',
                    content,
                    createdAt: serverTimestamp()
                });
                alert("Blog published!");
                document.getElementById('blog-title').value = '';
                document.getElementById('blog-image').value = '';
                document.getElementById('blog-content').value = '';
                loadBlogs();
            } catch (error) {
                alert("Error: " + error.message);
            }
        });

        async function loadBlogs() {
            const list = document.getElementById('blogs-list');
            list.innerHTML = 'Loading blogs...';
            const q = query(collection(db, "blogs"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            list.innerHTML = '';
            snapshot.forEach(docSnap => {
                const blog = docSnap.data();
                const div = document.createElement('div');
                div.className = 'content-item';
                div.innerHTML = `
          <div class="content-info">
            <h3>${blog.title}</h3>
            <p>${blog.createdAt?.toDate().toLocaleDateString() || 'Just now'}</p>
          </div>
          <button class="btn-delete" data-id="${docSnap.id}">Delete</button>
        `;
                div.querySelector('.btn-delete').onclick = () => deleteEntry("blogs", docSnap.id, loadBlogs);
                list.appendChild(div);
            });
        }

        // Piano Logic
        const addPianoBtn = document.getElementById('add-piano-btn');
        addPianoBtn.addEventListener('click', async () => {
            const title = document.getElementById('piano-title').value;
            const url = document.getElementById('piano-url').value;

            if (!title || !url) return alert("Title and URL are required");

            try {
                await addDoc(collection(db, "piano-videos"), {
                    title,
                    url: getEmbedUrl(url),
                    createdAt: serverTimestamp()
                });
                alert("Video added!");
                document.getElementById('piano-title').value = '';
                document.getElementById('piano-url').value = '';
                loadPianoVideos();
            } catch (error) {
                alert("Error: " + error.message);
            }
        });

        async function loadPianoVideos() {
            const list = document.getElementById('piano-list');
            list.innerHTML = 'Loading videos...';
            const q = query(collection(db, "piano-videos"), orderBy("createdAt", "desc"));
            const snapshot = await getDocs(q);
            list.innerHTML = '';
            snapshot.forEach(docSnap => {
                const video = docSnap.data();
                const div = document.createElement('div');
                div.className = 'content-item';
                div.innerHTML = `
          <div class="content-info">
            <h3>${video.title}</h3>
            <p>${video.url}</p>
          </div>
          <button class="btn-delete" data-id="${docSnap.id}">Delete</button>
        `;
                div.querySelector('.btn-delete').onclick = () => deleteEntry("piano-videos", docSnap.id, loadPianoVideos);
                list.appendChild(div);
            });
        }

        async function deleteEntry(coll, id, callback) {
            if (confirm("Are you sure you want to delete this?")) {
                await deleteDoc(doc(db, coll, id));
                callback();
            }
        }
    </script>
</body>

</html>